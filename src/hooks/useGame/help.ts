
// 获取卡牌
export function getCards() {
	return [
		{
			"suit": "clubs",
			"name": "2",
			"src": "Clubs-2.png",
			"value": 2
		},
		{
			"suit": "clubs",
			"name": "3",
			"src": "Clubs-3.png",
			"value": 3
		},
		{
			"suit": "clubs",
			"name": "4",
			"src": "Clubs-4.png",
			"value": 4
		},
		{
			"suit": "clubs",
			"name": "5",
			"src": "Clubs-5.png",
			"value": 5
		},
		{
			"suit": "clubs",
			"name": "6",
			"src": "Clubs-6.png",
			"value": 6
		},
		{
			"suit": "clubs",
			"name": "7",
			"src": "Clubs-7.png",
			"value": 7
		},
		{
			"suit": "clubs",
			"name": "8",
			"src": "Clubs-8.png",
			"value": 8
		},
		{
			"suit": "clubs",
			"name": "9",
			"src": "Clubs-9.png",
			"value": 9
		},
		{
			"suit": "clubs",
			"name": "10",
			"src": "Clubs-10.png",
			"value": 10
		},
		{
			"suit": "clubs",
			"name": "ace",
			"src": "Clubs-Ace.png",
			"value": 11
		},
		{
			"suit": "clubs",
			"name": "jack",
			"src": "Clubs-Jack.png",
			"value": 10
		},
		{
			"suit": "clubs",
			"name": "king",
			"src": "Clubs-King.png",
			"value": 10
		},
		{
			"suit": "clubs",
			"name": "queen",
			"src": "Clubs-Queen.png",
			"value": 10
		},
		{
			"suit": "diamonds",
			"name": "2",
			"src": "Diamond-2.png",
			"value": 2
		},
		{
			"suit": "diamonds",
			"name": "3",
			"src": "Diamond-3.png",
			"value": 3
		},
		{
			"suit": "diamonds",
			"name": "4",
			"src": "Diamond-4.png",
			"value": 4
		},
		{
			"suit": "diamonds",
			"name": "5",
			"src": "Diamond-5.png",
			"value": 5
		},
		{
			"suit": "diamonds",
			"name": "6",
			"src": "Diamond-6.png",
			"value": 6
		},
		{
			"suit": "diamonds",
			"name": "7",
			"src": "Diamond-7.png",
			"value": 7
		},
		{
			"suit": "diamonds",
			"name": "8",
			"src": "Diamond-8.png",
			"value": 8
		},
		{
			"suit": "diamonds",
			"name": "9",
			"src": "Diamond-9.png",
			"value": 9
		},
		{
			"suit": "diamonds",
			"name": "10",
			"src": "Diamond-10.png",
			"value": 10
		},
		{
			"suit": "diamonds",
			"name": "ace",
			"src": "Diamond-Ace.png",
			"value": 11
		},
		{
			"suit": "diamonds",
			"name": "jack",
			"src": "Diamond-Jack.png",
			"value": 10
		},
		{
			"suit": "diamonds",
			"name": "king",
			"src": "Diamond-King.png",
			"value": 10
		},
		{
			"suit": "diamonds",
			"name": "queen",
			"src": "Diamond-Queen.png",
			"value": 10
		},
		{
			"suit": "hearts",
			"name": "2",
			"src": "Hearts-2.png",
			"value": 2
		},
		{
			"suit": "hearts",
			"name": "3",
			"src": "Hearts-3.png",
			"value": 3
		},
		{
			"suit": "hearts",
			"name": "4",
			"src": "Hearts-4.png",
			"value": 4
		},
		{
			"suit": "hearts",
			"name": "5",
			"src": "Hearts-5.png",
			"value": 5
		},
		{
			"suit": "hearts",
			"name": "6",
			"src": "Hearts-6.png",
			"value": 6
		},
		{
			"suit": "hearts",
			"name": "7",
			"src": "Hearts-7.png",
			"value": 7
		},
		{
			"suit": "hearts",
			"name": "8",
			"src": "Hearts-8.png",
			"value": 8
		},
		{
			"suit": "hearts",
			"name": "9",
			"src": "Hearts-9.png",
			"value": 9
		},
		{
			"suit": "hearts",
			"name": "10",
			"src": "Hearts-10.png",
			"value": 10
		},
		{
			"suit": "hearts",
			"name": "ace",
			"src": "Hearts-Ace.png",
			"value": 11
		},
		{
			"suit": "hearts",
			"name": "jack",
			"src": "Hearts-Jack.png",
			"value": 10
		},
		{
			"suit": "hearts",
			"name": "king",
			"src": "Hearts-King.png",
			"value": 10
		},
		{
			"suit": "hearts",
			"name": "queen",
			"src": "Hearts-Queen.png",
			"value": 10
		},
		{
			"suit": "spades",
			"name": "2",
			"src": "Spades-2.png",
			"value": 2
		},
		{
			"suit": "spades",
			"name": "3",
			"src": "Spades-3.png",
			"value": 3
		},
		{
			"suit": "spades",
			"name": "4",
			"src": "Spades-4.png",
			"value": 4
		},
		{
			"suit": "spades",
			"name": "5",
			"src": "Spades-5.png",
			"value": 5
		},
		{
			"suit": "spades",
			"name": "6",
			"src": "Spades-6.png",
			"value": 6
		},
		{
			"suit": "spades",
			"name": "7",
			"src": "Spades-7.png",
			"value": 7
		},
		{
			"suit": "spades",
			"name": "8",
			"src": "Spades-8.png",
			"value": 8
		},
		{
			"suit": "spades",
			"name": "9",
			"src": "Spades-9.png",
			"value": 9
		},
		{
			"suit": "spades",
			"name": "10",
			"src": "Spades-10.png",
			"value": 10
		},
		{
			"suit": "spades",
			"name": "ace",
			"src": "Spades-Ace.png",
			"value": 11
		},
		{
			"suit": "spades",
			"name": "jack",
			"src": "Spades-Jack.png",
			"value": 10
		},
		{
			"suit": "spades",
			"name": "king",
			"src": "Spades-King.png",
			"value": 10
		},
		{
			"suit": "spades",
			"name": "queen",
			"src": "Spades-Queen.png",
			"value": 10
		}
	]
}

// 生成筹码
export const getChipList = () => {
	return [
		{
			src: '/img/10-chip.png',
			value: 10,
			id: 0
		},
		{
			src: '/img/20-chip.png',
			value: 20,
			id: 1
		},
		{
			src: '/img/50-chip.png',
			value: 50,
			id: 2
		},
		{
			src: '/img/100-chip.png',
			value: 100,
			id: 3
		}
	]
}


// 卡牌点数映射
export const CARD_VALUES: { [key: string]: number } = {
	'2': 2,
	'3': 3,
	'4': 4,
	'5': 5,
	'6': 6,
	'7': 7,
	'8': 8,
	'9': 9,
	'10': 10,
	'jack': 10,
	'queen': 10,
	'king': 10,
	'ace': 11
};

// 计算手牌点数
export const calculateHandValue = (hand: Card[]): number => {
	let value = hand.reduce((acc, card) => acc + CARD_VALUES[card?.name], 0);
	const aces = hand.filter(card => card?.name === 'ace').length;

	// 处理A的1/11值
	for (let i = 0; i < aces; i++) {
		if (value > 21) value -= 10;
	}
	return value;
};

// 定义卡牌类型
export type Card = {
	suit: string;
	name: string,
	src: string
	value: number
	hidden?: boolean; // 是否隐藏
};

export type GameResultType = 'win' | 'lose' | 'push' | ''

// 定义游戏状态类型
export type GameState = {
	deck: Card[]; // 卡牌堆
	playerHand: Card[][]; // 玩家手牌
	dealerHand: Card[]; // 庄家手牌
	currentHand: number; // 当前操作的手牌索引
	bet: number; // 当前下注金额
	dealerPoints: number; //庄家点数	
	playerPoints: [number, number] // 玩家点数
	gameOver: boolean | null;  // 游戏是否结束
	canDouble: boolean;   // 是否可以双倍下注
	canSplit: boolean;  // 是否可以分牌
	action: GameActions | null
	gameResult: GameResultType
};


// 定义当前游戏状态

export enum GameStatus {
	READY, // 游戏准备状态
	START, // 游戏开始状态
	OVER, // 游戏结束状态
}

// 消息状态
export enum MessageEnum {
	DEALER_WON = 'DEALER_WON', // 庄家赢
	PLAYER_WON = 'PLAYER_WON', // 玩家赢
	NULL = 'NULL',
	PUSH = 'PUSH',// 平局
}



export const MAP_MESSAGE_IMG: { [key: string]: string } = {
	'lose': '/img/dealerWon.png',
	'win': '/img/yourWon.png',
	'push': '/img/push.png'
}

export const MAP_MESSAGE_IMG_TOAST: { [key: string]: string } = {
	'lose': '/img/dealerWonToast.png',
	'win': '/img/playerWonToast.png',
	'push': '/img/pushToast.png'
}

export type GameActions = 'start' | 'hit' | 'stand' | 'double' | 'split'

export interface ICardItem {
	/** 牌名 / Card name */
	name: string; // 例如 "10", "A" / e.g. "10", "A"

	/** 花色 / Card suit */
	suit: string; // 例如 "clubs", "diamonds" / e.g. "clubs", "diamonds"

	/** 牌面值 / Card value */
	value: number; // A=1, 人头牌=10 / A=1, face cards=10

	/** 图片路径 / Image source path */
	src: string;

	/** 是否隐藏 / Whether card is hidden */
	hidden: boolean;
}

export interface SocketGameState {
	/** 事件类型 / Event type */
	e: string; // 固定为 "game_state" / Always "game_state" in this case

	/** 游戏数据 / Game data */
	d: {
		/** 当前游戏动作 / Current game action */
		action: GameActions; // 例如 "start" / e.g. "start"

		/** 游戏类型 / Game type */
		type: string;

		/** 玩家余额(筹码) / Player's current balance(chips) */
		balance: number;

		/** 玩家各手牌点数 / Array of points for each player hand */
		playerPoints: [number, number];

		/** 庄家可见点数 / Dealer's visible points */
		dealerPoints: number;

		/** 游戏消息 / Game message */
		message: string;

		/** 是否允许加倍 / Whether doubling is allowed */
		canDouble: boolean;

		/** 是否允许分牌 / Whether splitting is allowed */
		canSplit: boolean;

		/** 游戏是否结束 / Whether the game is over */
		gameOver: boolean;

		/** 当前操作的手牌索引(用于分牌后) / Index of current active hand (for split hands) */
		currentHand: number;

		/** 玩家钱包地址 / Player's wallet address */
		address: string;

		/** 验证签名 / Signature for verification */
		sign: string;

		/** 
		 * 玩家的手牌数组 
		 * Array of player hands (each hand is an array of cards)
		 */
		playerHands: ICardItem[][];

		/** 
		 * 庄家的手牌 
		 * Dealer's hand (array of cards)
		 */
		dealerHand: ICardItem[]

		/** 庄家是否有隐藏牌 / Whether dealer has hidden cards */
		dealerHidden: boolean;
		gameResult: GameResultType
		bet: number
	};
}

/** 防止重复添加卡牌 */
export const updateHandWithoutDuplicates = (prev: Card[], card: Card) => {
	return prev.some(c => c.src === card.src) ? prev : [...prev, card];
};
// 睡眠函数
export const sleep = async (timing: number = 1000) => {
	return new Promise(resolve => {
		setTimeout(resolve, timing)
	});
}

/** 顺序处理卡牌（带间隔） */
export const processCardsSequentially = async (cards: Card[], callback: (card: Card) => void) => {
	for (const card of cards) {
		await sleep();
		callback(card);
	}
};
